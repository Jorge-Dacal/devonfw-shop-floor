= dsf4openshift deployment environment

In this section you will see how you can create a new environment instance in OpenShift and the things that you must add to the Jenkinsfiles of your repository to deploy a branch in this new environment. To conclude you are going to see how to add config files for environment in the source code of the applications.

== Prerrequisite

=== OpenShift Cluster

To have your deployment environment with OpenShift you need to have an OpenShift Cluster.

// TODO: For example, you can obtain it from ITAAS

=== Download OpenShift Client Tools

First of all you need to download the OpenShift client, you can find it https://www.okd.io/download.html[here].

Remember that what you need to download *oc Client Tools* and not _OKD Server_.

NOTE: This tutorial has been made with the version 3.10.0 of the client, it is recommended to use the most current client, but if it does not work, it is possible that the instructions have become obsolete or that the OpenShift used needs another older/newer version of the client. To download a specific version of the client you can find here the https://github.com/openshift/origin/releases/[older versions] and the https://github.com/openshift/origin/releases/tag/v3.10.0[version 3.10.0].

=== Add oc client to path

Once you have downloaded the client you have to add it to the *PATH* environment variable.

=== Log into OpenShift with admin account

You can log using a terminal and executing the next instructions:

[source,Shell]
----
oc login $OpenShiftUrl
----

NOTE: You need a valid user to log in.

=== Select the project where you are going to create the environment

[source,Shell]
----
oc project $projectName
----

=== Add all the secrets that you need

For example, to create a secret for a nexus repository you should execute the next commands:

[source,Shell]
----
oc create secret docker-registry $nameForSecret --docker-server=${dockerRegistry} --docker-username=${user} --docker-password=${pass} --docker-email=no-reply@email.com

oc secrets link default $nameForSecret --for=pull
----

If you need to use that secret, you need to add the next code to the instruction:

[source,Shell]
----
--source-secret=$nameForSecret
----

== Configure OpenShift

=== Configure builds to create docker image using OpenShift

If you need to create docker images of your projects you could use OpenShift to do it _(Off course only if you have enough rights)_.

To do it, follow the next steps.

==== Create new builds configs

The first thing you need to do for create a new environment is prepare the builds for the front and for the middleware and rise default memory limits for the middleware. You can do it using a terminal and executing the next instructions:

These are a summary about the parameters used in our commands:

* *${dockerRegistry}*: The url of the docker repository.
* *${props.name}*: The name of the project (for example could be find on package.json)
* *${dockerTag}*: The tag of the image

NOTE: From now on you will refer to the name that you are going to give to the environment as *$enviroment*. Remember to modify it for the correct value in all instructions.

===== devon4ng build config

You need to create nginx build config with docker.

[source,Shell]
----
oc new-build --strategy docker --binary --docker-image nginx:alpine-perl --name=${props.name}-$environment --to=${dockerRegistry}/${props.name}:${dockerTag} --to-docker=true
----

NOTE: You need nginx:alpine-perl to read the environment config file in openshift, if you are not going to use it, devonfw recommend you to use nginx:latest instead.

===== devon4node build config

[source,Shell]
----
oc new-build --strategy docker --binary --docker-image node:lts --name=${props.name}-$environment --to=${dockerRegistry}/${props.name}:${dockerTag} --to-docker=true
----

===== devon4j build config

[source,Shell]
----
oc new-build --strategy docker --binary --docker-image openjdk:<version> --name=${props.name}-$environment --to=${dockerRegistry}/${props.name}:${dockerTag} --to-docker=true
----

NOTE: You need to specify the <version> of java used for your project. Also you can use the -alpine image. This image is based on the popular https://alpinelinux.org/[Alpine Linux project]. Alpine Linux is much smaller than most distribution base images (~5MB), and thus leads to much slimmer images in general. More information on https://hub.docker.com/_/openjdk/[docker hub].

===== How to use the build

In this step is where you will build a docker image from a compiled application.

====== Prerequisite

To build the source in OpenShift, first of all you need to compile your source and *obtain the artifacts* _"dist folder"_ or download it from a repository. Normally the artifacts have been built on Jenkins and have been stored in Nexus.

To download it, you can access to your registry, select the last version and download the _".tar"_. The next image show an example of where is the link to download it, marked in yellow:

image::./images/configuration/nexus-stored-artifacts.png[]

====== Build in OpenShift

When you have the artifacts, you can send them to your openshift and build them using your buildconfig that you created on the previous step. This is going to create a new docker image and push it to your registry. To do it you need to use a terminal and execute the following:

[source,Shell]
----
oc start-build ${props.name}-$environment --from-dir=${artifactsPath} --follow
----

NOTE: ${artifactsPath} is the path where you have the artifacts of the prerequisite (On jenkins is the dist folder generated by the build).

NOTE: Maybe you need to link:dsf-deployment-dsf4openshift.asciidoc#Raise/decrease-memory-or-CPU-limits[raise your memory or CPU limits].

=== Configure new environment

Now it is time to configure the environment.

==== Prerequisite

You need a docker image of your application.

==== Create new app on OpenShift

To create new app you need to use the next command.

[source,Shell]
----
oc new-app --docker-image=${artifactsPath} --name=${props.name}-$environment
----

NOTE: You could add environment variables using -e $name=$value


=== Import new images from registry

When you have new images in the registry you must import them to OpenShift. You could do it executing the next commands:

[source,Shell]
----
oc import-image ${props.name}-$environment --from=${dockerRegistry}/${props.name}:${dockerTag} --confirm
----

NOTE: Maybe you need to raise your memory or CPU limits. It is explained below.

=== Raise/decrease memory or CPU limits

If you need to raise (or decrease) the memory or CPU limits that you need, you could do it in OpenShift using the user interface. To do it you should enter in OpenShift and go to deployments.

image::./images/configuration/openshift-deployments-menu.png[]

At the right top, you could see a drop down actions, click on it and you could edit the resource limits of the container.

image::./images/configuration/openshift-deployments-actions.png[]

image::./images/configuration/openshift-deployments-resource-limits.png[]

Maybe you should modify the resource limits of the pod too. To do it you should click on drop down actions and go to edit YAML. Then you could see something like the next image.

image::./images/configuration/openshift-deployments-yaml-resources.png[]

In the image, you could see that appear resources two times. One at the bottom of the image, this are the container resources that you modified on the previous paragraph and another one at the top of the image. The resources of the top are for the pod, you should give to it at least the same of the sum for all containers that the pod use.

////
Using the interface:

Using command example:

[source,Shell]
----
oc patch bc/$project-api-$environment --patch "{\"spec\":{\"resources\":{\"limits\":{\"memory\": \"400Mi\"},\"requests\":{\"memory\": \"400Mi\"}}}}"
----
 ////

== Service integration with jenkins

=== Prerrequisite

To integrate it, you need to have installed the plugin OpenShift Client. To install it go to Manage Jenkins clicking on left menu and enter in *_Manage Plugins_*. Go to Available tab and search it using the filter textbox in the top right corner and install it.

=== Configuration

Second, you need to configure the OC Client. Go to Manage Jenkins clicking on left menu and enter in *_Global Tool Configuration_*.

Go to OpenShift Client Tools section and add a new one like this.

image::./images/configuration/openshift-jenkins-plugin.png[]

== Upgrade your Jenkinsfile

=== Add deployment stage

=== Add check status
